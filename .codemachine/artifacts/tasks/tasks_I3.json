[
  {
    "task_id": "I3.T1",
    "iteration_id": "I3",
    "iteration_goal": "Extend data model + specs for consignment/lifecycle features, implement consignment APIs + payout orchestration hooks, formalize media upload + processing flows (including diagrams), stand up DelayedJob workers with FFmpeg integration, and seed reporting projections consuming domain events.",
    "description": "Update Mermaid ERD with consignment-specific entities (Consignor, ConsignmentItem, CommissionRule, PayoutBatch), POS device tables, and media metadata tables; annotate archive policies.",
    "agent_type_hint": "DatabaseAgent",
    "inputs": "Section 2 data model, consignment requirements, ADRs.",
    "target_files": [
      "docs/diagrams/tenant-erd.mmd"
    ],
    "input_files": [],
    "deliverables": "Revised ERD with new tables + relationships, notes on partitioning/archival for audit-heavy tables.",
    "acceptance_criteria": "- All new entities include tenant_id, created_by metadata, and indexes.\n        - Diagram callouts mention Stripe Connect IDs + encryption fields (tax info).\n        - Version history appended in file comments referencing `I3.T1`.",
    "dependencies": [
      "I2.T5"
    ],
    "parallelizable": true,
    "done": false
  },
  {
    "task_id": "I3.T2",
    "iteration_id": "I3",
    "iteration_goal": "Extend data model + specs for consignment/lifecycle features, implement consignment APIs + payout orchestration hooks, formalize media upload + processing flows (including diagrams), stand up DelayedJob workers with FFmpeg integration, and seed reporting projections consuming domain events.",
    "description": "Create PlantUML sequence diagram for consignment payout authorization (Flow B) featuring Admin SPA, Identity, Feature Flags, Consignment module, Inventory, Payment layer, Stripe, Background Jobs, Reporting, Audit store.",
    "agent_type_hint": "DiagrammingAgent",
    "inputs": "Section 3 flow B narrative, updated ERD.",
    "target_files": [
      "docs/diagrams/seq-consignment-payout.puml"
    ],
    "input_files": [],
    "deliverables": "Sequence diagram annotated with impersonation markers, payout states, job triggers.",
    "acceptance_criteria": "- Diagram renders; includes notes about audit + reporting updates.\n        - Highlights feature flag gating autopayout vs manual.\n        - Links to Payment Provider interfaces for future providers.",
    "dependencies": [
      "I3.T1"
    ],
    "parallelizable": true,
    "done": false
  },
  {
    "task_id": "I3.T3",
    "iteration_id": "I3",
    "iteration_goal": "Extend data model + specs for consignment/lifecycle features, implement consignment APIs + payout orchestration hooks, formalize media upload + processing flows (including diagrams), stand up DelayedJob workers with FFmpeg integration, and seed reporting projections consuming domain events.",
    "description": "Implement Consignor + Consignment APIs (registration, batch intake, assignment to products), commission rule engine, payout batch persistence, and vendor portal endpoints referencing OpenAPI updates.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Updated ERD, consignment sequence diagram, ADRs.",
    "target_files": [
      "src/main/java/com/village/storefront/consignment/*.java",
      "src/main/resources/db/migrations/0005_consignment.sql",
      "api/openapi-catalog.yaml",
      "api/openapi-base.yaml",
      "src/test/java/com/village/storefront/consignment/ConsignmentResourceTest.java"
    ],
    "input_files": [],
    "deliverables": "REST resources for consignors/items/batches, Panache entities, MapStruct mappers, commission calculators with unit tests, and OpenAPI schemas.",
    "acceptance_criteria": "- Tests verify tenant isolation, commission math variations, and RLS enforcement.\n        - Vendor portal endpoints require scoped tokens; OpenAPI documents OAuth scopes.\n        - Payout batches emit domain events for Reporting subscription.",
    "dependencies": [
      "I2.T4",
      "I2.T5"
    ],
    "parallelizable": false,
    "done": false
  },
  {
    "task_id": "I3.T4",
    "iteration_id": "I3",
    "iteration_goal": "Extend data model + specs for consignment/lifecycle features, implement consignment APIs + payout orchestration hooks, formalize media upload + processing flows (including diagrams), stand up DelayedJob workers with FFmpeg integration, and seed reporting projections consuming domain events.",
    "description": "Implement media upload service: presigned URL endpoint, upload session table, checksum validation, storage client abstraction (S3/R2), and admin UI integration stub; update OpenAPI spec.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Section 3 media pipeline notes, ERD updates, feature flag ADR.",
    "target_files": [
      "src/main/java/com/village/storefront/media/*.java",
      "src/main/resources/db/migrations/0006_media.sql",
      "api/openapi-base.yaml",
      "src/test/java/com/village/storefront/media/MediaResourceTest.java"
    ],
    "input_files": [],
    "deliverables": "REST endpoints for upload request + completion, storage adapter interface, configuration placeholders for Cloudflare R2 credentials, tests mocking storage client.",
    "acceptance_criteria": "- Presigned URLs scoped per tenant + TTL; tests verify validation of file size + MIME types.\n        - Upload completion enqueues background job referencing ADR payload schema.\n        - OpenAPI spec documents handshake sequence + error responses.",
    "dependencies": [
      "I2.T6",
      "I2.T5"
    ],
    "parallelizable": false,
    "done": false
  },
  {
    "task_id": "I3.T5",
    "iteration_id": "I3",
    "iteration_goal": "Extend data model + specs for consignment/lifecycle features, implement consignment APIs + payout orchestration hooks, formalize media upload + processing flows (including diagrams), stand up DelayedJob workers with FFmpeg integration, and seed reporting projections consuming domain events.",
    "description": "Author PlantUML sequence diagram for media pipeline (Flow C) from admin upload → presigned URL → background FFmpeg job → catalog media update → storefront notification.",
    "agent_type_hint": "DiagrammingAgent",
    "inputs": "Task `I3.T4`, Section 3 Flow C narrative.",
    "target_files": [
      "docs/diagrams/seq-media-processing.puml"
    ],
    "input_files": [],
    "deliverables": "Diagram with lanes for Merchant, Admin SPA, Identity, Feature Flags, Media Controller, R2, Job Worker, FFmpeg, Catalog, Reporting, Storefront.",
    "acceptance_criteria": "- Highlights synchronous vs asynchronous operations, timeouts, retries.\n        - Notes signed URL security and EXIF stripping requirement.\n        - Referenced within README + plan manifest.",
    "dependencies": [
      "I3.T4"
    ],
    "parallelizable": true,
    "done": false
  },
  {
    "task_id": "I3.T6",
    "iteration_id": "I3",
    "iteration_goal": "Extend data model + specs for consignment/lifecycle features, implement consignment APIs + payout orchestration hooks, formalize media upload + processing flows (including diagrams), stand up DelayedJob workers with FFmpeg integration, and seed reporting projections consuming domain events.",
    "description": "Implement DelayedJob worker subsystem: job entity, leasing logic, worker CLI, FFmpeg invocation wrapper, metrics emission, and integration tests verifying retry/backoff/resume.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Job governance ADR, media task.",
    "target_files": [
      "src/main/java/com/village/storefront/jobs/*.java",
      "src/main/java/com/village/storefront/media/MediaProcessingJob.java",
      "src/test/java/com/village/storefront/jobs/JobWorkerTest.java",
      "tools/ffmpeg/version.md"
    ],
    "input_files": [],
    "deliverables": "Worker scheduler, queue CLI commands, FFmpeg wrapper verifying binary availability, metrics instrumentation hooking OpenTelemetry/Prometheus.",
    "acceptance_criteria": "- Worker respects queue priorities + exponential backoff from ADR.\n        - Job payload schema validated before execution; invalid payloads logged + moved to dead letter table.\n        - Tests simulate FFmpeg failure + recovery; coverage >85% for worker module.",
    "dependencies": [
      "I3.T4"
    ],
    "parallelizable": false,
    "done": false
  },
  {
    "task_id": "I3.T7",
    "iteration_id": "I3",
    "iteration_goal": "Extend data model + specs for consignment/lifecycle features, implement consignment APIs + payout orchestration hooks, formalize media upload + processing flows (including diagrams), stand up DelayedJob workers with FFmpeg integration, and seed reporting projections consuming domain events.",
    "description": "Seed reporting projection service: domain event schema, projection tables (sales summary, consignment payouts, media processing metrics), ETL job templates, and OpenAPI endpoints for retrieving aggregated data.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Domain events from tasks `I3.T3`/`I3.T4`, Section 3 Reporting notes.",
    "target_files": [
      "src/main/java/com/village/storefront/reporting/*.java",
      "src/main/resources/db/migrations/0007_reporting.sql",
      "api/openapi-base.yaml",
      "src/test/java/com/village/storefront/reporting/ReportingResourceTest.java"
    ],
    "input_files": [],
    "deliverables": "Domain event envelope object, polling worker skeleton, reporting tables + DTOs, endpoints for payouts + media KPIs with SSE stub for dashboards.",
    "acceptance_criteria": "- Projection worker consumes events idempotently; tests simulate duplicate events.\n        - Aggregation tables include `data_freshness_timestamp` and indexes for filters.\n        - API responses documented in OpenAPI with caching guidance.",
    "dependencies": [
      "I3.T3",
      "I3.T4"
    ],
    "parallelizable": false,
    "done": false
  }
]