[
  {
    "task_id": "I4.T1",
    "iteration_id": "I4",
    "iteration_goal": "Ship production-ready checkout orchestration with Stripe payments, loyalty/gift card support, media processing pipeline, and POS offline flows.",
    "description": "Implement PaymentProvider framework + Stripe providers (PaymentProvider, PaymentMethodProvider, MarketplaceProvider, WebhookHandler); include Connect onboarding, payout scheduling, fee calculation, webhook ingestion, integration tests.",
    "agent_type_hint": "BackendAgent",
    "inputs": "ADRs, OpenAPI, Stripe docs.",
    "target_files": [
      "src/main/java/com/village/payment/**",
      "tests/backend/StripeProviderTest.java",
      "tests/backend/StripeWebhookIT.java",
      "docs/payments/stripe_connect.md"
    ],
    "input_files": [
      "api/v1/openapi.yaml",
      "docs/adr/ADR-004-consignment-payouts.md",
      "docs/diagrams/sequence_checkout_payment.mmd"
    ],
    "deliverables": "Payment provider interfaces + Stripe implementation, webhook idempotency storage, docs describing onboarding + platform fees.",
    "acceptance_criteria": "Stripe sandbox integration works end-to-end, platform fees configurable per tenant, webhooks persisted + idempotent, docs show onboarding steps.",
    "dependencies": [
      "I2.T4",
      "I3.T1",
      "I3.T3"
    ],
    "parallelizable": false,
    "done": true
  },
  {
    "task_id": "I4.T2",
    "iteration_id": "I4",
    "iteration_goal": "Ship production-ready checkout orchestration with Stripe payments, loyalty/gift card support, media processing pipeline, and POS offline flows.",
    "description": "Implement checkout orchestrator: saga handling address validation, shipping rates (USPS/UPS/FedEx adapters), loyalty redemption, gift cards/store credit, payment capture, audit logging, error handling, retrieval endpoints.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Sequence diagram, cart services, payment provider, loyalty spec.",
    "target_files": [
      "src/main/java/com/village/checkout/orchestrator/**",
      "src/main/java/com/village/shipping/**",
      "tests/backend/CheckoutSagaTest.java",
      "tests/backend/ShippingAdapterIT.java",
      "docs/checkout/saga.md"
    ],
    "input_files": [
      "docs/diagrams/sequence_checkout_payment.mmd",
      "src/main/java/com/village/checkout/cart/**",
      "src/main/java/com/village/payment/**",
      "docs/adr/ADR-003-checkout-saga.md"
    ],
    "deliverables": "Orchestrator service, adapter layer wrappers, audit + domain events, doc describing compensation + kill switches.",
    "acceptance_criteria": "Saga handles success/failure, integrates with payments + loyalty, shipping adapters stub external APIs, logs actions with trace IDs, tests cover success + failure + compensations.",
    "dependencies": [
      "I2.T4",
      "I4.T1",
      "I4.T4"
    ],
    "parallelizable": false,
    "done": true
  },
  {
    "task_id": "I4.T3",
    "iteration_id": "I4",
    "iteration_goal": "Ship production-ready checkout orchestration with Stripe payments, loyalty/gift card support, media processing pipeline, and POS offline flows.",
    "description": "Build media pipeline: upload negotiation endpoints, presigned URLs, tenant quotas, Thumbnailator for images, FFmpeg for video with HLS, background jobs, signed URL service, metadata persistence, API integration for storefront/admin.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Media requirements, ERD (MediaAsset/Derivative), job framework.",
    "target_files": [
      "src/main/java/com/village/media/**",
      "tests/backend/MediaPipelineTest.java",
      "docs/media/pipeline.md",
      "src/main/resources/application.properties"
    ],
    "input_files": [
      "docs/diagrams/datamodel_erd.puml",
      "docs/architecture_overview.md",
      "src/main/java/com/village/jobs/**"
    ],
    "deliverables": "Media services, FFmpeg invocation wrapper, queue integration, doc describing storage layout + TTLs.",
    "acceptance_criteria": "Images/video processed with size tiers, signed URLs generated per tenant, quotas enforced, tests simulate FFmpeg via stub, doc explains failure retries.",
    "dependencies": [
      "I1.T5",
      "I3.T6"
    ],
    "parallelizable": false,
    "done": true
  },
  {
    "task_id": "I4.T4",
    "iteration_id": "I4",
    "iteration_goal": "Ship production-ready checkout orchestration with Stripe payments, loyalty/gift card support, media processing pipeline, and POS offline flows.",
    "description": "Implement loyalty + rewards module: point accrual rules, ledger, redemption engine, tier calculations, admin APIs, storefront components integration (cart summary), reporting hooks.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Requirements, ERD (LoyaltyLedger), checkout saga design.",
    "target_files": [
      "src/main/java/com/village/loyalty/**",
      "tests/backend/LoyaltyServiceTest.java",
      "tests/backend/LoyaltyLedgerIT.java",
      "docs/loyalty/program.md"
    ],
    "input_files": [
      "docs/diagrams/datamodel_erd.puml",
      "api/v1/openapi.yaml",
      "docs/checkout/saga.md"
    ],
    "deliverables": "Ledger entity/service, accrual + redemption APIs, admin endpoints for configuration, documentation for tier logic.",
    "acceptance_criteria": "Points accrual + redemption operate per config, ledger persists with audit fields, checkout integrates, admin endpoints secured, docs outline formulas.",
    "dependencies": [
      "I2.T4",
      "I3.T3"
    ],
    "parallelizable": true,
    "done": true
  },
  {
    "task_id": "I4.T5",
    "iteration_id": "I4",
    "iteration_goal": "Ship production-ready checkout orchestration with Stripe payments, loyalty/gift card support, media processing pipeline, and POS offline flows.",
    "description": "Document media pipeline sequence (upload -> processing -> CDN) via Mermaid + ops runbook; include scaling guidance, failure scenarios, kill switches, capacity planning.",
    "agent_type_hint": "DiagrammingAgent",
    "inputs": "Media implementation, job policies.",
    "target_files": [
      "docs/diagrams/sequence_media_pipeline.mmd",
      "docs/operations/media_runbook.md"
    ],
    "input_files": [
      "src/main/java/com/village/media/**",
      "docs/media/pipeline.md",
      "k8s/base/deployment-workers.yaml"
    ],
    "deliverables": "Diagram + runbook with kill-switch instructions, queue scaling, troubleshooting.",
    "acceptance_criteria": "Diagram renders, runbook outlines detection/response steps, references Section 6 verification metrics.",
    "dependencies": [
      "I4.T3"
    ],
    "parallelizable": false,
    "done": true
  },
  {
    "task_id": "I4.T6",
    "iteration_id": "I4",
    "iteration_goal": "Ship production-ready checkout orchestration with Stripe payments, loyalty/gift card support, media processing pipeline, and POS offline flows.",
    "description": "Enhance gift cards + store credit modules and integrate with checkout & POS: APIs for issuance/redemption, ledger, admin UI wiring, POS offline usage.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Checkout saga, loyalty spec, POS requirements.",
    "target_files": [
      "src/main/java/com/village/giftcard/**",
      "src/main/java/com/village/storecredit/**",
      "tests/backend/GiftCardServiceTest.java",
      "tests/backend/StoreCreditIT.java",
      "docs/payments/giftcard.md"
    ],
    "input_files": [
      "docs/diagrams/datamodel_erd.puml",
      "api/v1/openapi.yaml",
      "src/main/java/com/village/checkout/orchestrator/**",
      "src/main/java/com/village/pos/**"
    ],
    "deliverables": "Gift card/store credit services, endpoints, integration with checkout/POS, docs for issuance + redemption.",
    "acceptance_criteria": "Gift card codes unique + secure, redemption atomic, checkout + POS flows handle partial payments, docs describe lifecycle.",
    "dependencies": [
      "I4.T2",
      "I4.T4"
    ],
    "parallelizable": false,
    "done": false
  },
  {
    "task_id": "I4.T7",
    "iteration_id": "I4",
    "iteration_goal": "Ship production-ready checkout orchestration with Stripe payments, loyalty/gift card support, media processing pipeline, and POS offline flows.",
    "description": "Implement POS offline queue + Stripe Terminal integration: offline storage encryption, sync jobs, UI states, hardware pairing service, documentation.",
    "agent_type_hint": "FrontendAgent",
    "inputs": "POS requirements, job framework, payment provider.",
    "target_files": [
      "src/main/webui/admin-spa/src/modules/pos/offline/**",
      "src/main/java/com/village/pos/offline/**",
      "tests/admin/POSOffline.spec.ts",
      "tests/backend/POSOfflineIT.java",
      "docs/pos/offline.md"
    ],
    "input_files": [
      "src/main/webui/admin-spa/src/modules/pos/**",
      "src/main/java/com/village/payment/**",
      "docs/operations/job_runbook.md"
    ],
    "deliverables": "Offline queue manager, encryption keys, sync job hooking into checkout, UI indicators + hold/resume features, doc for staff training.",
    "acceptance_criteria": "Offline queue persists encrypted payloads, sync resumes automatically, UI highlights offline state, Stripe Terminal flows validated in sandbox.",
    "dependencies": [
      "I4.T1",
      "I4.T2",
      "I3.T6"
    ],
    "parallelizable": false,
    "done": false
  }
]
