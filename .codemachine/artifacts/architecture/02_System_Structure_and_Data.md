<!-- anchor: system-architecture-blueprint -->
# System Architecture Blueprint: Village Storefront

**Version:** 1.0
**Date:** 2026-01-02
**Generated By:** Structural_Data_Architect

<!-- anchor: 1-introduction-and-goals -->
## 1. Introduction & Goals

*   **1.1. Project Vision:** Village Storefront delivers a multi-tenant SaaS storefront and admin platform that unifies Shopify-grade merchandising, ConsignCloud-level consignment parity, and SaaS governance into one Quarkus-based foundation so merchants of any size can launch curated commerce experiences without provisioning infrastructure.
*   **1.2. Key Objectives:**
    - Guarantee strict tenant isolation through subdomain-aware TenantContext resolution, PostgreSQL RLS, and Panache filters that defend every repository call.
    - Deliver a unified storefront built with Qute, Tailwind, and PrimeUI that can be themed per-tenant without diverging from the shared deployment artifact.
    - Provide a Vue 3 + PrimeVue admin experience under /admin that orchestrates catalog, consignment, loyalty, POS, and reporting workflows via OpenAPI-governed APIs.
    - Embed consignment vendor onboarding, commission tracking, payouts, and portal features at parity with ConsignCloud while remaining configurable per category and consignor.
    - Enable checkout, shipping, taxes, and payment orchestration that leans on Stripe Connect for settlement while abstracting providers behind PaymentProvider interfaces.
    - Instrument comprehensive session, impersonation, and audit logging so platform admins and compliance teams can trace every significant action with tenant context.
    - Support background media processing, report generation, and scheduled maintenance through the DelayedJob pattern plus Quarkus schedulers without external brokers.
    - Expose headless APIs for catalog, cart, and account operations to fuel partner-built sites or embedded commerce while preserving rate limits and feature flag governance.
    - Maintain observability, feature flag kill switches, and security layering mandated by the foundation so every module can scale independently on Kubernetes.
    - Keep data contracts extensible for future phases (loyalty tiers, POS, subscriptions, multi-currency display) without breaking the modular monolith seams.
*   **1.3. Scope:** The blueprint covers the Quarkus modular monolith, storefront rendering stack, admin SPA delivery, PostgreSQL schemas with tenant discriminator columns, DelayedJob-backed background execution, feature flag services, and integration adapters for Stripe, carriers, Cloudflare R2, email, FFmpeg, and address validation. Third-party marketing tooling, analytics beyond defined reports, or future microservice splits are explicitly out-of-scope but accommodated via deliberate seams.
*   **1.4. Key Assumptions:**
    - Per Foundation Section 6.0, digital products use signed URLs with 24-hour expiry and at most five download attempts, so storage metadata must track attempt counts and signature versioning.
    - Stripe remains the only live payment rail in Phase 1, yet the PaymentProvider interfaces (Section 5.0) must stay production-ready for PayPal or CashApp pilots without schema churn.
    - POS offline blobs are encrypted locally and replayed sequentially; the backend must trust offline-generated UUIDs and reconcile using first-accepted semantics.
    - Reporting MVP favors scheduled exports plus aggregated dashboard tiles; ad-hoc drill-downs and streaming dashboards are future enhancements requiring no schema mutation now.
    - Feature flags govern every tenant-facing capability (Foundation Section 3.0), so endpoints include metadata for required toggles and degrade gracefully when disabled.
    - Media caching relies on hashed object keys rather than CDN purge calls, mandating metadata fields for content versioning and signed URL expiry per tenant.
    - No Redis is available, so Caffeine caches plus PostgreSQL token buckets absorb all throttling, rate limit, and feature toggle caching strategies.

<!-- anchor: 2-architectural-drivers -->
## 2. Architectural Drivers

*   **2.1. Functional Requirements Summary:** The system must let platform admins onboard tenants, merchants build branded catalogs with physical, digital, subscription, and consignment inventory, shoppers browse and checkout with persistent carts, staff fulfill multi-location orders, consignors monitor balances, and background services process media, payouts, and reports—all guarded by impersonation-aware audits.
*   **2.2. Non-Functional Requirements (NFRs):**
    - <200ms median API latency and <2s storefront render times through native Quarkus builds, tuned Panache queries, and CDN-backed static assets.
    - 99.99% availability for tenant resolution and auth services, with JWT statelessness enabling horizontal scaling across Kubernetes pods.
    - JaCoCo ≥80% coverage in CI, Spotless-enforced code style, and OpenAPI spec-first governance to maintain contract fidelity.
    - Structured JSON logging with tenant_id, store_id, user_id, and correlation_id on every log as mandated in Foundation Section 3.0.
    - Observability via OpenTelemetry traces, Prometheus metrics, and health probes supporting blue/green deployments.
    - Data retention and archival policies (90-day hot storage, JSONL gzip archive to R2) applied automatically via scheduled jobs.
    - PII safeguards for consignor tax info using pgcrypto/application-level encryption with key rotation metadata.
    - Browser accessibility (WCAG 2.1 AA) across storefront and admin UI using PrimeUI/PrimeVue patterns validated in CI.
*   **2.3. Constraints & Preferences:**
    - Architectural style locked to a layered modular monolith in Quarkus (Foundation Section 2.0) with CDI interfaces enforcing seams.
    - Java 21 + Quarkus with GraalVM native images, Maven build, Spotless, JaCoCo, and GitHub Actions CI/CD are non-negotiable.
    - PostgreSQL 17 with tenant_id discriminator columns plus RLS is the sole database; MyBatis Migrations handle schema evolution with reversible scripts.
    - Qute + Tailwind + PrimeUI for storefront, Vue 3 + Vite + PrimeVue for admin, both sharing design tokens stored in PostgreSQL.
    - DelayedJob pattern via database tables for all async workloads; no external brokers or Redis caches allowed.
    - Cloudflare R2 (S3-compatible) is the canonical object storage, and FFmpeg must run via process execution packaged in the container image.
    - Stripe Connect is the mandated payment provider for launch, incorporating Stripe Terminal for POS, with PaymentProvider abstraction ready for expansion.
    - Kubernetes (k3s target) orchestrates deployments via Quarkus-generated manifests plus Kustomize overlays per environment.

<!-- anchor: 3-proposed-architecture -->
## 3. Proposed Architecture (Structural View)

*   **3.1. Architectural Style:** Layered modular monolith per Foundation Section 2.0, with bounded-context modules (catalog, orders, consignment, loyalty, POS, media, platform-ops) exposing CDI interfaces and domain events so subsystems can later be extracted without schema rewrites. Layers include presentation (Qute/Vue), application services orchestrating workflows, domain modules encapsulating business logic, and infrastructure/adapters abstracting integrations.
*   **3.2. Technology Stack Summary:**
| Layer | Technology | Notes |
| --- | --- | --- |
| Runtime & Framework | Java 21 + Quarkus (RESTEasy Reactive, Qute, Panache, Scheduler) | GraalVM native builds for cold-start <100ms, CDI wiring for modular boundaries. |
| Storefront UI | Qute templates + Tailwind CSS + PrimeUI | All customer routes except /admin rendered server-side with tenant design tokens. |
| Admin UI | Vue 3 + Vite + TypeScript + PrimeVue | Served under /admin via Quinoa plugin, consumes OpenAPI-generated clients. |
| Database | PostgreSQL 17 + MyBatis Migrations | Shared schema with tenant_id columns, RLS policies, partitioned session/audit tables. |
| Caching | Caffeine (in-memory per pod) | Caches product fragments, rate-limit counters, feature flags without external cache dependency. |
| Object Storage | Cloudflare R2 via AWS S3 SDK | Stores originals and processed media variants with tenant-prefixed keys. |
| Payments | Stripe + Stripe Connect | Implements PaymentProvider + MarketplaceProvider interfaces with webhook handlers. |
| Async Processing | Database-backed DelayedJob tables + Quarkus Scheduler | Handles emails, payouts, media work, reporting, and cleanup. |
| Observability | OpenTelemetry, Prometheus, Structured JSON logging | Tenant-aware tracing, metrics scraping, and liveness/readiness probes. |
| CI/CD & Deployment | Maven + Spotless + JaCoCo + GitHub Actions + Quarkus Kubernetes Extension | Produces native container images, validates coverage, and emits manifests for k3s. |
*   **3.3. System Context Diagram (C4 Level 1):**
    *   **Description:** Shows how Village Storefront (Quarkus modular monolith) interacts with personas (merchants, staff, customers, consignors, platform admins, headless partners, auditors) and critical external services such as Stripe Connect, carrier APIs, Cloudflare R2, DNS/SSL automation, OAuth providers, tax calculators, analytics destinations, and transactional mail relays.
    *   **Diagram (PlantUML):**
        ~~~plantuml
        @startuml
        !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
        LAYOUT_LEFT_RIGHT()
        Person(merchant, "Merchant Admin", "Creates stores, configures catalog, and enforces tenant branding policies.")
        Person(staff, "Store Staff", "Fulfills orders, adjusts inventory, and supports customers.")
        Person(customer, "Customer Shopper", "Browses storefront pages, manages carts, and completes checkout.")
        Person(consignor, "Consignor Vendor", "Supplies consignment inventory and tracks balances and payouts.")
        Person(platformAdmin, "Platform Admin", "Operates the SaaS platform, manages tenants, and impersonates users with audits.")
        Person(headlessDeveloper, "Headless Partner Developer", "Integrates tenant APIs into custom or static sites.")
        Person(posClerk, "POS Clerk", "Uses browser-based POS and hardware integrations to process in-person sales.")
        Person(supportAgent, "Support Agent", "Assists shoppers, handles loyalty adjustments, and triages impersonation tickets.")
        Person(auditor, "Compliance Auditor", "Reviews audit logs, retention evidence, and impersonation markers.")
        Person(integrationEngineer, "Integration Engineer", "Extends shipping, tax, and marketing adapters via APIs.")
        System_Ext(stripe, "Stripe Connect", "Primary payment processor, onboarding, payouts, disputes, and Stripe Terminal.")
        System_Ext(carrierApis, "Carrier APIs", "USPS, UPS, and FedEx for rates, labels, and tracking webhooks.")
        System_Ext(cloudflareR2, "Cloudflare R2", "Object storage for uploads, processed media variants, and archives.")
        System_Ext(emailProvider, "SMTP / SES Mail", "Transactional email delivery with environment-based domain filtering.")
        System_Ext(addressValidation, "Postal Validation APIs", "USPS and commercial services verifying addresses at checkout.")
        System_Ext(analyticsStack, "Analytics & BI Destinations", "Downstream BI warehouses consuming report exports and event streams.")
        System_Ext(taxService, "Tax Calculation Service", "Configurable tax engines producing jurisdictional tax items.")
        System_Ext(socialLogin, "OAuth Providers", "Google, Facebook, Apple login endpoints for optional social auth.")
        System_Ext(ffmpegRuntime, "FFmpeg Runtime", "Packaged CLI used for video/image processing via background jobs.")
        System_Ext(dnsProvider, "DNS & SSL Automation", "Let's Encrypt ACME endpoints and DNS providers for custom domains.")
        System_Ext(webhookTargets, "Webhook Consumers", "Future outbound webhooks for marketing or analytics systems.")
        System_Ext(featureFlagReview, "Feature Flag Governance Portal", "Ops tooling reviewing tenant-specific flags and rollout state.")
        System_Ext(headlessStorefront, "Headless Storefront Channels", "Static sites or mobile apps consuming headless APIs.")
        System_Boundary(vsfBoundary, "Village Storefront Platform") {
            System(vsfCore, "Village Storefront", "Quarkus modular monolith delivering storefront, admin, APIs, and background execution.")
        }
        ' Merchant Admin inbound interactions
        Rel(merchant, vsfCore, "Manages tenant onboarding and plan selection", "HTTPS / Admin SPA (Vue)")
        Rel(merchant, vsfCore, "Manages subdomain and custom domain configuration", "HTTPS / Admin SPA (Vue)")
        Rel(merchant, vsfCore, "Manages branding token and theme customization", "HTTPS / Admin SPA (Vue)")
        Rel(merchant, vsfCore, "Manages catalog hierarchy and variant modeling", "HTTPS / Admin SPA (Vue)")
        Rel(merchant, vsfCore, "Manages consignment commission rule setup", "HTTPS / Admin SPA (Vue)")
        Rel(merchant, vsfCore, "Manages shipping profile and carrier credential management", "HTTPS / Admin SPA (Vue)")
        Rel(merchant, vsfCore, "Manages staff RBAC invitation workflows", "HTTPS / Admin SPA (Vue)")
        Rel(merchant, vsfCore, "Manages Stripe Connect configuration and payout tuning", "HTTPS / Admin SPA (Vue)")
        Rel(merchant, vsfCore, "Manages feature flag opt-in for loyalty, POS, and subscriptions", "HTTPS / Admin SPA (Vue)")
        Rel(merchant, vsfCore, "Manages operational dashboard review and report scheduling", "HTTPS / Admin SPA (Vue)")
        ' Store Staff inbound interactions
        Rel(staff, vsfCore, "Manages order processing across fulfillment states", "HTTPS / Admin SPA (Vue)")
        Rel(staff, vsfCore, "Manages inventory adjustments and transfer execution", "HTTPS / Admin SPA (Vue)")
        Rel(staff, vsfCore, "Manages shipping label generation and tracking capture", "HTTPS / Admin SPA (Vue)")
        Rel(staff, vsfCore, "Manages return authorization intake", "HTTPS / Admin SPA (Vue)")
        Rel(staff, vsfCore, "Manages customer service ticket handling", "HTTPS / Admin SPA (Vue)")
        Rel(staff, vsfCore, "Manages loyalty adjustment and store credit issuance", "HTTPS / Admin SPA (Vue)")
        Rel(staff, vsfCore, "Manages POS configuration updates", "HTTPS / Admin SPA (Vue)")
        Rel(staff, vsfCore, "Manages bulk pricing and publishing edits", "HTTPS / Admin SPA (Vue)")
        ' Customer Shopper inbound interactions
        Rel(customer, vsfCore, "Manages product discovery and search", "HTTPS / Qute Storefront")
        Rel(customer, vsfCore, "Manages cart maintenance and save-for-later", "HTTPS / Qute Storefront")
        Rel(customer, vsfCore, "Manages guest and authenticated checkout", "HTTPS / Qute Storefront")
        Rel(customer, vsfCore, "Manages discount code and gift card redemption", "HTTPS / Qute Storefront")
        Rel(customer, vsfCore, "Manages loyalty point application", "HTTPS / Qute Storefront")
        Rel(customer, vsfCore, "Manages address management and validation", "HTTPS / Qute Storefront")
        Rel(customer, vsfCore, "Manages order history review", "HTTPS / Qute Storefront")
        Rel(customer, vsfCore, "Manages digital download retrieval", "HTTPS / Qute Storefront")
        Rel(customer, vsfCore, "Manages account preference updates", "HTTPS / Qute Storefront")
        Rel(customer, vsfCore, "Manages headless widget usage", "HTTPS / Qute Storefront")
        ' Consignor Vendor inbound interactions
        Rel(consignor, vsfCore, "Manages consignor balance monitoring", "HTTPS / Consignor Portal")
        Rel(consignor, vsfCore, "Manages commission statement review", "HTTPS / Consignor Portal")
        Rel(consignor, vsfCore, "Manages tax info maintenance", "HTTPS / Consignor Portal")
        Rel(consignor, vsfCore, "Manages intake batch submission", "HTTPS / Consignor Portal")
        Rel(consignor, vsfCore, "Manages notification acknowledgement", "HTTPS / Consignor Portal")
        Rel(consignor, vsfCore, "Manages support inquiry creation", "HTTPS / Consignor Portal")
        ' Platform Admin inbound interactions
        Rel(platformAdmin, vsfCore, "Manages tenant onboarding oversight", "HTTPS / Platform Console")
        Rel(platformAdmin, vsfCore, "Manages impersonation start and stop approvals", "HTTPS / Platform Console")
        Rel(platformAdmin, vsfCore, "Manages platform feature flag coordination", "HTTPS / Platform Console")
        Rel(platformAdmin, vsfCore, "Manages cross-tenant analytics review", "HTTPS / Platform Console")
        Rel(platformAdmin, vsfCore, "Manages custom domain certificate validation", "HTTPS / Platform Console")
        Rel(platformAdmin, vsfCore, "Manages session anomaly investigation", "HTTPS / Platform Console")
        Rel(platformAdmin, vsfCore, "Manages payout reconciliation", "HTTPS / Platform Console")
        Rel(platformAdmin, vsfCore, "Manages compliance export orchestration", "HTTPS / Platform Console")
        ' Headless Partner Developer inbound interactions
        Rel(headlessDeveloper, vsfCore, "Manages OAuth client credential management", "HTTPS / OAuth Headless API")
        Rel(headlessDeveloper, vsfCore, "Manages catalog API consumption", "HTTPS / OAuth Headless API")
        Rel(headlessDeveloper, vsfCore, "Manages cart and order API usage", "HTTPS / OAuth Headless API")
        Rel(headlessDeveloper, vsfCore, "Manages rate limit monitoring", "HTTPS / OAuth Headless API")
        Rel(headlessDeveloper, vsfCore, "Manages error reporting with correlation IDs", "HTTPS / OAuth Headless API")
        Rel(headlessDeveloper, vsfCore, "Manages schema update tracking", "HTTPS / OAuth Headless API")
        ' POS Clerk inbound interactions
        Rel(posClerk, vsfCore, "Manages PIN-based login", "HTTPS / POS Shell")
        Rel(posClerk, vsfCore, "Manages barcode scanning and quick sale lookup", "HTTPS / POS Shell")
        Rel(posClerk, vsfCore, "Manages split payment capture", "HTTPS / POS Shell")
        Rel(posClerk, vsfCore, "Manages offline queue creation", "HTTPS / POS Shell")
        Rel(posClerk, vsfCore, "Manages cash drawer events", "HTTPS / POS Shell")
        Rel(posClerk, vsfCore, "Manages receipt delivery preferences", "HTTPS / POS Shell")
        ' Support Agent inbound interactions
        Rel(supportAgent, vsfCore, "Manages cross-tenant customer search", "HTTPS / Support Toolkit")
        Rel(supportAgent, vsfCore, "Manages impersonation log inspection", "HTTPS / Support Toolkit")
        Rel(supportAgent, vsfCore, "Manages goodwill credit issuance", "HTTPS / Support Toolkit")
        Rel(supportAgent, vsfCore, "Manages session anomaly triage", "HTTPS / Support Toolkit")
        Rel(supportAgent, vsfCore, "Manages fraud review collaboration", "HTTPS / Support Toolkit")
        Rel(supportAgent, vsfCore, "Manages templated communication dispatch", "HTTPS / Support Toolkit")
        ' Compliance Auditor inbound interactions
        Rel(auditor, vsfCore, "Manages audit export retrieval", "HTTPS / Audit Workbench")
        Rel(auditor, vsfCore, "Manages archive manifest validation", "HTTPS / Audit Workbench")
        Rel(auditor, vsfCore, "Manages impersonation review", "HTTPS / Audit Workbench")
        Rel(auditor, vsfCore, "Manages RBAC change verification", "HTTPS / Audit Workbench")
        Rel(auditor, vsfCore, "Manages retention policy confirmation", "HTTPS / Audit Workbench")
        ' Integration Engineer inbound interactions
        Rel(integrationEngineer, vsfCore, "Manages shipping adapter extension", "HTTPS / Integration APIs")
        Rel(integrationEngineer, vsfCore, "Manages webhook endpoint registration", "HTTPS / Integration APIs")
        Rel(integrationEngineer, vsfCore, "Manages OAuth client lifecycle management", "HTTPS / Integration APIs")
        Rel(integrationEngineer, vsfCore, "Manages beta integration rollout", "HTTPS / Integration APIs")
        Rel(integrationEngineer, vsfCore, "Manages catalog/inventory synchronization", "HTTPS / Integration APIs")
        ' Platform feedback to Merchant Admin
        Rel(vsfCore, merchant, "Provides revenue and margin dashboards", "Dashboards / Email alerts")
        Rel(vsfCore, merchant, "Provides low-stock notifications", "Dashboards / Email alerts")
        Rel(vsfCore, merchant, "Provides payout readiness alerts", "Dashboards / Email alerts")
        Rel(vsfCore, merchant, "Provides feature flag availability notices", "Dashboards / Email alerts")
        Rel(vsfCore, merchant, "Provides SSL renewal warnings", "Dashboards / Email alerts")
        ' Platform feedback to Store Staff
        Rel(vsfCore, staff, "Provides fulfillment task lists", "In-app toasts / Email digests")
        Rel(vsfCore, staff, "Provides carrier outage advisories", "In-app toasts / Email digests")
        Rel(vsfCore, staff, "Provides support ticket reminders", "In-app toasts / Email digests")
        Rel(vsfCore, staff, "Provides POS variance summaries", "In-app toasts / Email digests")
        Rel(vsfCore, staff, "Provides inventory approval prompts", "In-app toasts / Email digests")
        ' Platform feedback to Customer Shopper
        Rel(vsfCore, customer, "Provides order confirmations", "Storefront UI / Email")
        Rel(vsfCore, customer, "Provides shipping status updates", "Storefront UI / Email")
        Rel(vsfCore, customer, "Provides digital download links", "Storefront UI / Email")
        Rel(vsfCore, customer, "Provides loyalty balance summaries", "Storefront UI / Email")
        Rel(vsfCore, customer, "Provides cart expiration nudges", "Storefront UI / Email")
        ' Platform feedback to Consignor Vendor
        Rel(vsfCore, consignor, "Provides payout statements", "Portal dashboards / Email")
        Rel(vsfCore, consignor, "Provides sale notifications", "Portal dashboards / Email")
        Rel(vsfCore, consignor, "Provides expiration alerts", "Portal dashboards / Email")
        Rel(vsfCore, consignor, "Provides tax document requests", "Portal dashboards / Email")
        Rel(vsfCore, consignor, "Provides maintenance advisories", "Portal dashboards / Email")
        ' Platform feedback to Platform Admin
        Rel(vsfCore, platformAdmin, "Provides queue health metrics", "Ops console / Pager alerts")
        Rel(vsfCore, platformAdmin, "Provides impersonation completion logs", "Ops console / Pager alerts")
        Rel(vsfCore, platformAdmin, "Provides SLA breach notifications", "Ops console / Pager alerts")
        Rel(vsfCore, platformAdmin, "Provides cross-tenant export availability", "Ops console / Pager alerts")
        Rel(vsfCore, platformAdmin, "Provides key rotation reminders", "Ops console / Pager alerts")
        ' Platform feedback to Headless Partner Developer
        Rel(vsfCore, headlessDeveloper, "Provides schema change notices", "Developer portal")
        Rel(vsfCore, headlessDeveloper, "Provides rate limit warnings", "Developer portal")
        Rel(vsfCore, headlessDeveloper, "Provides webhook replay payloads", "Developer portal")
        Rel(vsfCore, headlessDeveloper, "Provides SDK bundle downloads", "Developer portal")
        Rel(vsfCore, headlessDeveloper, "Provides incident communications", "Developer portal")
        ' Platform feedback to POS Clerk
        Rel(vsfCore, posClerk, "Provides offline sync prompts", "POS UI / Printers")
        Rel(vsfCore, posClerk, "Provides register checklist workflows", "POS UI / Printers")
        Rel(vsfCore, posClerk, "Provides reader pairing statuses", "POS UI / Printers")
        Rel(vsfCore, posClerk, "Provides receipt delivery controls", "POS UI / Printers")
        Rel(vsfCore, posClerk, "Provides loyalty adjustment failures", "POS UI / Printers")
        ' Platform feedback to Support Agent
        Rel(vsfCore, supportAgent, "Provides SLA timers", "Support dashboards")
        Rel(vsfCore, supportAgent, "Provides impersonation timeout reminders", "Support dashboards")
        Rel(vsfCore, supportAgent, "Provides secure transcript archives", "Support dashboards")
        Rel(vsfCore, supportAgent, "Provides incident updates", "Support dashboards")
        Rel(vsfCore, supportAgent, "Provides audit extract availability", "Support dashboards")
        ' Platform feedback to Compliance Auditor
        Rel(vsfCore, auditor, "Provides signed archive manifests", "Audit exports")
        Rel(vsfCore, auditor, "Provides retention attestations", "Audit exports")
        Rel(vsfCore, auditor, "Provides access token logs", "Audit exports")
        Rel(vsfCore, auditor, "Provides compliance runbooks", "Audit exports")
        Rel(vsfCore, auditor, "Provides scope change notifications", "Audit exports")
        ' Platform feedback to Integration Engineer
        Rel(vsfCore, integrationEngineer, "Provides adapter health metrics", "Integration console")
        Rel(vsfCore, integrationEngineer, "Provides sandbox event replays", "Integration console")
        Rel(vsfCore, integrationEngineer, "Provides credential rotation alerts", "Integration console")
        Rel(vsfCore, integrationEngineer, "Provides payload schema diffs", "Integration console")
        Rel(vsfCore, integrationEngineer, "Provides rate limit usage reports", "Integration console")
        ' External system interactions
        Rel(vsfCore, stripe, "Creates PaymentIntents, captures, refunds, and Connect onboarding", "HTTPS / Stripe SDK")
        Rel(stripe, vsfCore, "Sends charge, payout, dispute, and Terminal webhooks", "Webhook / HMAC")
        Rel(vsfCore, carrierApis, "Requests rates, buys labels, and syncs tracking", "HTTPS / Carrier APIs")
        Rel(carrierApis, vsfCore, "Pushes tracking events and delivery exceptions", "Webhook / JSON")
        Rel(vsfCore, cloudflareR2, "Stores media, archives, and report exports", "S3 API")
        Rel(cloudflareR2, vsfCore, "Serves signed media and archive downloads", "Signed HTTPS")
        Rel(vsfCore, emailProvider, "Sends transactional mail with domain filtering", "SMTP / SES")
        Rel(vsfCore, addressValidation, "Validates shipping addresses", "HTTPS / JSON")
        Rel(vsfCore, analyticsStack, "Publishes scheduled exports", "HTTPS / Secure download")
        Rel(vsfCore, taxService, "Calculates jurisdictional taxes", "HTTPS / REST")
        Rel(vsfCore, socialLogin, "Runs OAuth login handshakes", "OAuth 2.0")
        Rel(socialLogin, vsfCore, "Returns identity tokens", "HTTPS / JWT")
        Rel(vsfCore, ffmpegRuntime, "Invokes FFmpeg for transcoding", "Process execution")
        Rel(vsfCore, dnsProvider, "Automates Let's Encrypt certificates", "HTTPS / ACME")
        Rel(dnsProvider, vsfCore, "Confirms certificate issuance", "Webhook / JSON")
        Rel(vsfCore, webhookTargets, "(Future) emits outbound webhooks", "HTTPS / HMAC")
        Rel(vsfCore, featureFlagReview, "Syncs flag governance metadata", "HTTPS / Admin API")
        Rel(headlessStorefront, vsfCore, "Consumes headless APIs", "HTTPS / OAuth")
        Rel(vsfCore, headlessStorefront, "Delivers webhooks for headless channels", "Webhook / JSON")
        Rel(vsfCore, analyticsStack, "Streams impersonation audit data (future)", "Batch / Future streaming")
        Rel(vsfCore, stripe, "Pairs Stripe Terminal readers for POS", "Stripe Terminal API")
        Rel(stripe, vsfCore, "Reports Terminal reader status", "Webhook / JSON")
        Rel(vsfCore, cloudflareR2, "Archives audit logs beyond 90 days", "S3 API")
        Rel(vsfCore, emailProvider, "Queues delayed mail jobs", "SMTP / Retry")
        Rel(vsfCore, taxService, "Requests VAT/GST readiness metadata", "HTTPS / JSON")
        @enduml
        ~~~
*   **3.4. Container Diagram (C4 Level 2):**
    *   **Description:** Decomposes the platform into deployable containers: Quarkus API core, Storefront Qute engine, Admin SPA (Vue/Vite) assets, background job worker pods, media pipeline workers, reporting projections, feature flag service layer, POS shell, and data stores (PostgreSQL, Cloudflare R2). External containers include Stripe, carrier APIs, DNS/SSL services, analytics, and mail relays.
    *   **Diagram (PlantUML):**
        ~~~plantuml
        @startuml
        !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
        LAYOUT_WITH_LEGEND()
        Person(merchant, "Merchant Admin", "Configures store and monitors KPIs.")
        Person(staff, "Store Staff", "Operates day-to-day fulfillment and service.")
        Person(customer, "Customer Shopper", "Uses storefront and account pages.")
        Person(consignor, "Consignor Vendor", "Accesses vendor portal.")
        Person(platformAdmin, "Platform Admin", "Runs SaaS operations and compliance.")
        Person(posClerk, "POS Clerk", "Conducts in-person sales and cash management.")
        Person(headlessDeveloper, "Headless Partner", "Consumes APIs for custom channels.")
        System_Boundary(vsfContainers, "Village Storefront Platform") {
            Container(quarkusCore, "Quarkus API Core", "Java 21 / Quarkus Native", "Hosts REST APIs, Tenant Access Gateway, domain services, and background schedulers.")
            Container(storefrontEngine, "Storefront Rendering Engine", "Qute + Tailwind + PrimeUI", "Server-rendered storefront with tenant design tokens and hydration bundles.")
            Container(adminSpa, "Admin SPA Bundle", "Vue 3 + Vite + PrimeVue", "SPA assets served via Quinoa; bootstraps tenant config and feature flags.")
            Container(headlessApi, "Headless API Gateway", "RESTEasy Reactive", "Exposes catalog/cart/order APIs for external channels with OAuth scopes.")
            Container(backgroundWorker, "Background Job Worker", "Quarkus worker pod", "Executes DelayedJob payloads for emails, payouts, reports, and cleanup.")
            Container(mediaWorker, "Media Pipeline Worker", "Quarkus + FFmpeg", "Processes images/video, generates thumbnails, manages signed URLs.")
            Container(reportingProjection, "Reporting Projection Service", "Quarkus + Panache", "Builds aggregated tables powering dashboards and exports.")
            Container(platformOps, "Platform Admin Backend", "Quarkus subsystem", "Provides SaaS governance APIs, impersonation, and compliance tooling.")
            Container(posShell, "Web POS Shell", "PrimeVue + Stripe Terminal", "Delivers register UI with offline capabilities and hardware bridge.")
            Container(featureFlagService, "Feature Toggle Service", "Caffeine + PostgreSQL", "Caches tenant overrides and enforces kill switches.")
            ContainerDb(postgres, "PostgreSQL Cluster", "PostgreSQL 17", "Primary relational store with RLS, partitions, and migrations.")
            Container(delayedJobTable, "DelayedJob Queue Tables", "PostgreSQL Schema", "Priority queues (CRITICAL through BULK) storing background jobs.")
            Container(caffeineCache, "Caffeine Cache Layer", "In-pod cache", "Holds product fragments, feature flags, and rate limit counters.")
            Container(kubernetesAdapters, "Kubernetes Adapter", "Quarkus Kubernetes Extension", "Generates manifests, ConfigMaps, Secrets, and HPAs.")
            Container(quinoaBuilder, "Quinoa Build Orchestrator", "Quinoa Plugin", "Builds Vue SPA and injects design tokens.")
            Container(otelAgent, "Observability Agent", "OpenTelemetry Exporter", "Emits traces and metrics to Jaeger/Prometheus.")
            Container(securityServices, "Security & Audit Services", "Quarkus modules", "Handles JWT issuance, session logs, audit trail persistence.")
        }
        System_Ext(stripe, "Stripe Connect", "Payments, payouts, Terminal")
        System_Ext(carrierApis, "Carrier APIs", "Rates, labels, tracking")
        System_Ext(cloudflareR2, "Cloudflare R2", "Object storage")
        System_Ext(emailProvider, "SMTP / SES", "Transactional mail")
        System_Ext(addressValidation, "Address Validation", "USPS + third-party")
        System_Ext(analyticsStack, "Analytics Destinations", "BI warehouses")
        System_Ext(dnsProvider, "DNS & SSL", "Let's Encrypt / ACME")
        System_Ext(taxService, "Tax Service", "Jurisdictional tax rules")
        System_Ext(socialLogin, "OAuth Providers", "Google, Facebook, Apple")
        System_Ext(featureFlagReview, "Feature Flag Governance", "Ops portal")
        System_Ext(headlessStorefront, "Headless Channels", "Static sites / apps")
        System_Ext(ffmpegRuntime, "FFmpeg Runtime", "Packaged binary")
        System_Ext(monitoringStack, "Jaeger/Prometheus", "Observability backends")
        ' Persona to container interactions
        Rel(merchant, adminSpa, "Configures tenant storefront, catalog, and consignment modules", "HTTPS / SPA")
        Rel(merchant, platformOps, "Manages plan, billing, and compliance escalations", "HTTPS / REST")
        Rel(merchant, reportingProjection, "Reads dashboards and exports aggregated insights", "HTTPS / JSON")
        Rel(staff, adminSpa, "Processes orders, inventory, and returns", "HTTPS / SPA")
        Rel(staff, posShell, "Operates POS alongside admin features", "HTTPS / POS Shell")
        Rel(customer, storefrontEngine, "Browses storefront and completes checkout", "HTTPS / Qute")
        Rel(customer, headlessApi, "Uses APIs via embedded widgets or partner apps", "HTTPS / OAuth")
        Rel(consignor, adminSpa, "Accesses consignor portal views for payouts", "HTTPS / SPA")
        Rel(platformAdmin, platformOps, "Operates SaaS governance, impersonation, and analytics", "HTTPS / Console")
        Rel(platformAdmin, securityServices, "Reviews audit trails and session logs", "HTTPS / JSON")
        Rel(posClerk, posShell, "Runs register UI with offline sync", "HTTPS / Web App")
        Rel(headlessDeveloper, headlessApi, "Consumes spec-first APIs for custom experiences", "HTTPS / REST")
        ' Internal container dependencies
        Rel(storefrontEngine, quarkusCore, "Invokes controllers for product, cart, checkout, and loyalty operations", "CDI / RESTEasy")
        Rel(adminSpa, quarkusCore, "Calls admin APIs for catalog, inventory, consignment, loyalty, POS, and reporting configuration", "HTTPS / JSON")
        Rel(headlessApi, quarkusCore, "Routes tenant-aware API requests through TenantContext", "HTTPS / OAuth")
        Rel(quarkusCore, postgres, "Persists transactional data with RLS policies", "Panache / JDBC")
        Rel(quarkusCore, featureFlagService, "Retrieves tenant feature toggles cached in Caffeine", "CDI / Cache")
        Rel(featureFlagService, postgres, "Stores feature definitions, overrides, and metadata", "SQL")
        Rel(quarkusCore, caffeineCache, "Caches catalog fragments, rate limits, and tokens", "In-memory")
        Rel(backgroundWorker, postgres, "Claims DelayedJob rows and writes execution results", "SQL / Advisory Locks")
        Rel(backgroundWorker, cloudflareR2, "Uploads reports, archives, and processed media", "S3 API")
        Rel(mediaWorker, cloudflareR2, "Reads originals, writes derivatives, and updates metadata", "S3 API")
        Rel(mediaWorker, ffmpegRuntime, "Executes FFmpeg for transcoding and thumbnail extraction", "Process Execution")
        Rel(reportingProjection, postgres, "Reads domain tables and writes aggregates", "SQL")
        Rel(platformOps, quarkusCore, "Consumes tenant APIs and publishes governance actions", "CDI / REST")
        Rel(platformOps, securityServices, "Logs impersonation context and approvals", "CDI Events")
        Rel(quarkusCore, kubernetesAdapters, "Emits deployment manifests and config metadata", "Quarkus Extension")
        Rel(quarkusCore, quinoaBuilder, "Triggers SPA builds with tenant design tokens at build time", "Plugin")
        Rel(quarkusCore, otelAgent, "Exports traces and metrics for observability", "OpenTelemetry")
        Rel(securityServices, postgres, "Writes JWT, session, audit, and impersonation logs", "SQL")
        Rel(quarkusCore, delayedJobTable, "Enqueues background work with priority and retry metadata", "SQL")
        Rel(featureFlagService, caffeineCache, "Caches resolved flag states per tenant and scope", "In-memory")
        Rel(posShell, quarkusCore, "Synchronizes offline transactions, loyalty, and inventory adjustments", "HTTPS / JSON")
        Rel(headlessApi, featureFlagService, "Validates API access against beta flags", "CDI / Cache")
        Rel(reportingProjection, cloudflareR2, "Stores large exports and shareable assets", "S3 API")
        ' External container connections
        Rel(quarkusCore, stripe, "Creates PaymentIntents, handles webhooks, and manages Stripe Connect onboarding", "HTTPS + Webhooks")
        Rel(quarkusCore, carrierApis, "Fetches shipping rates and prints labels", "HTTPS")
        Rel(quarkusCore, addressValidation, "Validates addresses during checkout and account updates", "HTTPS")
        Rel(quarkusCore, socialLogin, "Runs OAuth flows for social login", "HTTPS / OAuth")
        Rel(quarkusCore, dnsProvider, "Automates SSL issuance for custom domains", "HTTPS / ACME")
        Rel(backgroundWorker, emailProvider, "Sends transactional emails with retries", "SMTP / SES")
        Rel(backgroundWorker, analyticsStack, "Publishes scheduled reports and telemetry", "HTTPS")
        Rel(platformOps, featureFlagReview, "Syncs feature owners, expiry, and audit notes", "HTTPS")
        Rel(headlessApi, headlessStorefront, "Serves headless clients with OAuth-signed responses", "HTTPS")
        Rel(otelAgent, monitoringStack, "Exports traces, logs, and metrics", "OTLP / Prometheus")
        Rel(mediaWorker, cloudflareR2, "Stores processed media and CDN-friendly assets", "S3 API")
        Rel(posShell, stripe, "Pairs and uses Stripe Terminal readers for card payments", "Stripe Terminal API")
        Rel(platformOps, analyticsStack, "Feeds platform-wide KPIs for leadership", "HTTPS / Batch")
        Rel(quarkusCore, taxService, "Calculates taxes for checkout and reporting", "HTTPS")
        Rel(featureFlagService, featureFlagReview, "Publishes metrics about flag usage and drift", "HTTPS")
        @enduml
        ~~~
*   **3.5. Component Diagram (C4 Level 3 - Quarkus API Core):**
    *   **Description:** Focuses on the Quarkus API container, highlighting components mandated in the foundation: Tenant Access Gateway, Identity & Session Service, Catalog & Inventory Domain, Consignment Module, Checkout & Order Orchestrator, Payment Integration Layer, Loyalty & Rewards Module, POS Processor, Media Pipeline Controller, Reporting Projection Coordinator, Feature Flag Service, and Platform Admin Backend.
    *   **Diagram (PlantUML):**
        ~~~plantuml
        @startuml
        !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml
        LAYOUT_LEFT_RIGHT()
        Container_Boundary(quarkusCoreBoundary, "Quarkus API Core") {
            Component(tenantGateway, "Tenant Access Gateway", "JAX-RS ContainerRequestFilter", "Parses Host/custom domain, resolves tenant, populates TenantContext, enforces CORS.")
            Component(identityService, "Identity & Session Service", "JWT Issuer + Session Logger", "Handles authentication, refresh tokens, session logs, MFA, and impersonation controls.")
            Component(catalogModule, "Catalog & Inventory Module", "Panache Repositories", "Manages products, variants, categories, collections, inventory locations, adjustments, and events.")
            Component(consignmentModule, "Consignment Module", "Domain Service", "Manages consignor profiles, commission rules, intake batches, payouts, and notifications.")
            Component(checkoutOrchestrator, "Checkout & Order Orchestrator", "Service Layer", "Coordinates cart persistence, address validation, shipping rates, payments, and order state transitions.")
            Component(paymentIntegration, "Payment Integration Layer", "PaymentProvider Interfaces", "Wraps Stripe (and future providers) for charge, refund, capture, payout, and webhook idempotency.")
            Component(loyaltyModule, "Loyalty & Rewards Module", "Domain Service", "Handles points accrual, redemption, tier upgrades, expirations, and ledger entries.")
            Component(posProcessor, "POS & Offline Processor", "Service Layer", "Processes POS carts, offline transaction reconciliation, hardware integration hooks.")
            Component(mediaController, "Media Pipeline Controller", "Service + Job Enqueuer", "Validates uploads, enforces limits, queues FFmpeg jobs, and tracks media metadata.")
            Component(reportingCoordinator, "Reporting & Analytics Coordinator", "Projection Builder", "Consumes domain events, builds aggregates, and exposes report APIs.")
            Component(featureFlagService, "Feature Flag Service", "Caffeine-backed Service", "Loads platform + tenant overrides, enforces kill switches, logs usage.")
            Component(platformAdminBackend, "Platform Admin Backend", "SaaS Governance API", "Provides store lifecycle management, impersonation workflows, cross-tenant analytics.")
            Component(backgroundScheduler, "Background Job Scheduler", "Quarkus Scheduler", "Enqueues recurring jobs (archival, certificate renewal, payout audits).")
        }
        ' Component interactions
        Rel(tenantGateway, identityService, "Passes tenant-aware auth context for login and refresh pipelines", "CDI")
        Rel(tenantGateway, catalogModule, "Applies tenant filters to catalog queries", "CDI")
        Rel(identityService, platformAdminBackend, "Provides impersonation tokens and session metadata", "CDI")
        Rel(catalogModule, checkoutOrchestrator, "Supplies product availability, pricing, and inventory policies", "CDI")
        Rel(catalogModule, consignmentModule, "Shares variant references for consignor assignments via domain services", "CDI")
        Rel(consignmentModule, reportingCoordinator, "Publishes consignor balance events for aggregates", "Domain Events")
        Rel(checkoutOrchestrator, paymentIntegration, "Requests authorizations, captures, refunds, and Connect payouts", "PaymentProvider Interfaces")
        Rel(checkoutOrchestrator, loyaltyModule, "Applies loyalty accrual and redemption during checkout", "CDI")
        Rel(checkoutOrchestrator, posProcessor, "Shares cart orchestration logic for POS flows", "Shared Service")
        Rel(posProcessor, paymentIntegration, "Uses Stripe Terminal flows for card payments", "PaymentProvider")
        Rel(mediaController, backgroundScheduler, "Enqueues FFmpeg jobs and cleanup operations", "DelayedJob")
        Rel(mediaController, catalogModule, "Updates media references and signed URL metadata", "CDI")
        Rel(reportingCoordinator, platformAdminBackend, "Feeds cross-tenant analytics and dashboards", "CDI")
        Rel(featureFlagService, catalogModule, "Controls exposure of beta catalog features", "Caffeine Cache")
        Rel(featureFlagService, checkoutOrchestrator, "Gates experimental checkout flows and payment providers", "Caffeine Cache")
        Rel(featureFlagService, platformAdminBackend, "Exposes override APIs and audit logging", "CDI")
        Rel(backgroundScheduler, identityService, "Rotates secrets, tokens, and session archives", "Scheduled Jobs")
        Rel(backgroundScheduler, reportingCoordinator, "Triggers nightly aggregate rebuilds", "Scheduled Jobs")
        Rel(platformAdminBackend, consignmentModule, "Allows platform admins to review consignor disputes", "CDI")
        Rel(platformAdminBackend, checkoutOrchestrator, "Enforces kill switches for checkout when incidents arise", "Feature Flag Hook")
        Rel(loyaltyModule, reportingCoordinator, "Supplies loyalty ledger snapshots for BI", "Domain Events")
        Rel(posProcessor, consignmentModule, "Ensures consignor payouts update after POS sales", "CDI")
        Rel(backgroundScheduler, platformAdminBackend, "Runs suspension audits and plan compliance checks", "Scheduled Jobs")
        Rel(identityService, audit_event, "Persists login, impersonation, and token actions", "Audit Tables")
        Rel(checkoutOrchestrator, audit_event, "Logs checkout saga milestones", "Audit Tables")
        Rel(paymentIntegration, webhook_event, "Stores webhook payloads for idempotency", "Webhook Table")
        @enduml
        ~~~
*   **3.6. Data Model Overview & ERD:**
    *   **Description:** Captures the multi-tenant data entities defined in Foundation Section 5.0, covering tenancy, users, customers, sessions, catalog, inventory, consignment, carts, orders, payments, shipments, returns, loyalty, feature flags, audit events, and background jobs. Every tenant-scoped table contains tenant_id and adheres to RLS policies.
    *   **Key Entities:**
        - `Tenant` governs store metadata, plan, status, branding, and configuration flags.
        - `StoreUser` stores merchant/staff accounts with hashed passwords, roles, and status.
        - `Customer` holds shopper identities, authentication, loyalty balances, and preferences.
        - `Product` and `Variant` capture catalog hierarchy, SKUs, pricing, inventory policy, and media references.
        - `InventoryLocation` and `InventoryLevel` define stock tracking across warehouses, stores, and suppliers.
        - `Consignor` and `ConsignmentItem` store vendor agreements, commission rules, item aging, and payout state.
        - `Cart`, `CartItem`, and `Order` maintain purchase journeys including discounts, shipping, taxes, and timeline events.
        - `PaymentIntent` and `Refund` represent provider-agnostic payment operations with provider references and statuses.
        - `Shipment` and `ReturnAuthorization` capture fulfillment and reverse logistics data.
        - `LoyaltyLedgerEntry` tracks points accrual, redemption, tier progression, and expirations.
        - `FeatureFlag`, `AuditEvent`, and `BackgroundJob` provide platform governance, observability, and async orchestration data.
    *   **Diagram (PlantUML - ERD):**
        ~~~plantuml
        @startuml
        entity "Tenant" as tenant {
            * id : uuid
            --
            subdomain : citext
            custom_domains : jsonb
            plan : text
            status : text
            base_currency : char(3)
            branding : jsonb
            config_flags : jsonb
            created_at : timestamptz
            suspended_at : timestamptz
            deleted_at : timestamptz
            created_by : uuid
            updated_by : uuid
        }
        entity "StoreUser" as store_user {
            * id : uuid
            --
            tenant_id : uuid
            email : citext
            hashed_password : text
            roles : text[]
            permissions : jsonb
            status : text
            last_login_at : timestamptz
            mfa_secret : text
            staff_profile : jsonb
            created_at : timestamptz
            updated_at : timestamptz
            created_by : uuid
            updated_by : uuid
        }
        entity "Customer" as customer {
            * id : uuid
            --
            tenant_id : uuid
            email : citext
            password_hash : text
            name : text
            addresses : jsonb
            phone : text
            loyalty_balance_minor : bigint
            preferences : jsonb
            marketing_consent : jsonb
            created_at : timestamptz
            updated_at : timestamptz
            deleted_at : timestamptz
        }
        entity "SessionLog" as session_log {
            * id : uuid
            --
            tenant_id : uuid
            user_type : text
            user_id : uuid
            ip : inet
            user_agent : text
            login_at : timestamptz
            last_activity_at : timestamptz
            logout_reason : text
            device_fingerprint : text
            impersonation_context : jsonb
        }
        entity "Product" as product {
            * id : uuid
            --
            tenant_id : uuid
            title : text
            slug : citext
            description : text
            status : text
            visibility_window : tstzrange
            seo : jsonb
            category_ids : uuid[]
            collection_ids : uuid[]
            custom_attributes : jsonb
            created_at : timestamptz
            updated_at : timestamptz
            version : integer
        }
        entity "Variant" as variant {
            * id : uuid
            --
            tenant_id : uuid
            product_id : uuid
            sku : text
            barcode : text
            option_values : jsonb
            price_minor : bigint
            compare_at_minor : bigint
            inventory_policy : text
            weight_grams : integer
            dimensions : jsonb
            media_ids : uuid[]
            created_at : timestamptz
            updated_at : timestamptz
            version : integer
        }
        entity "Category" as category {
            * id : uuid
            --
            tenant_id : uuid
            name : text
            slug : citext
            parent_id : uuid
            breadcrumbs : jsonb
            visible : boolean
            created_at : timestamptz
        }
        entity "Collection" as collection {
            * id : uuid
            --
            tenant_id : uuid
            name : text
            slug : citext
            rules : jsonb
            manual : boolean
            sort_strategy : text
            created_at : timestamptz
        }
        entity "InventoryLocation" as inventory_location {
            * id : uuid
            --
            tenant_id : uuid
            name : text
            address : jsonb
            type : text
            capacity : jsonb
            timezone : text
            created_at : timestamptz
        }
        entity "InventoryLevel" as inventory_level {
            * id : uuid
            --
            tenant_id : uuid
            variant_id : uuid
            location_id : uuid
            on_hand : integer
            reserved : integer
            incoming : integer
            safety_stock : integer
            low_stock_threshold : integer
            updated_at : timestamptz
        }
        entity "Consignor" as consignor {
            * id : uuid
            --
            tenant_id : uuid
            contact : jsonb
            tax_info_encrypted : bytea
            commission_rules : jsonb
            payout_preferences : jsonb
            portal_access_token : text
            status : text
            created_at : timestamptz
            updated_at : timestamptz
        }
        entity "ConsignmentItem" as consignment_item {
            * id : uuid
            --
            tenant_id : uuid
            variant_id : uuid
            consignor_id : uuid
            cost_basis_minor : bigint
            received_at : timestamptz
            expires_at : timestamptz
            status : text
            aging_days : integer
            payout_state : text
            payout_reference : text
        }
        entity "Cart" as cart {
            * id : uuid
            --
            tenant_id : uuid
            customer_id : uuid
            guest_email : citext
            currency : char(3)
            subtotal_minor : bigint
            discount_minor : bigint
            shipping_minor : bigint
            tax_minor : bigint
            grand_total_minor : bigint
            items : jsonb
            discounts : jsonb
            shipping_address : jsonb
            billing_address : jsonb
            last_activity_at : timestamptz
            feature_flags_snapshot : jsonb
        }
        entity "Order" as orders {
            * id : uuid
            --
            tenant_id : uuid
            order_number : text
            customer_id : uuid
            cart_id : uuid
            status : text
            payment_state : text
            fulfillment_state : text
            totals : jsonb
            shipping_address : jsonb
            billing_address : jsonb
            timeline : jsonb
            notes : jsonb
            tags : text[]
            loyalty_snapshot : jsonb
            created_at : timestamptz
            updated_at : timestamptz
            version : integer
        }
        entity "OrderItem" as order_item {
            * id : uuid
            --
            tenant_id : uuid
            order_id : uuid
            variant_id : uuid
            title : text
            sku : text
            quantity : integer
            price_minor : bigint
            discount_minor : bigint
            tax_minor : bigint
            consignor_id : uuid
            metadata : jsonb
        }
        entity "PaymentIntent" as payment_intent {
            * id : uuid
            --
            tenant_id : uuid
            order_id : uuid
            provider : text
            provider_reference : text
            amount_minor : bigint
            currency : char(3)
            application_fee_minor : bigint
            status : text
            captured_at : timestamptz
            failure_reason : text
            metadata : jsonb
        }
        entity "Refund" as refund {
            * id : uuid
            --
            tenant_id : uuid
            payment_intent_id : uuid
            amount_minor : bigint
            currency : char(3)
            reason : text
            processed_at : timestamptz
            provider_reference : text
            status : text
            metadata : jsonb
        }
        entity "Shipment" as shipment {
            * id : uuid
            --
            tenant_id : uuid
            order_id : uuid
            carrier : text
            service_level : text
            tracking_number : text
            labels : jsonb
            packages : jsonb
            status : text
            shipped_at : timestamptz
            delivered_at : timestamptz
            metadata : jsonb
        }
        entity "ReturnAuthorization" as return_auth {
            * id : uuid
            --
            tenant_id : uuid
            order_id : uuid
            items : jsonb
            reason_codes : text[]
            status : text
            approved_by : uuid
            received_at : timestamptz
            restock_decision : text
            refund_amount_minor : bigint
            notes : jsonb
        }
        entity "LoyaltyLedgerEntry" as loyalty_ledger {
            * id : uuid
            --
            tenant_id : uuid
            customer_id : uuid
            order_id : uuid
            points_delta : integer
            balance_after : integer
            reason : text
            source : text
            expires_at : timestamptz
            created_at : timestamptz
        }
        entity "FeatureFlag" as feature_flag {
            * id : uuid
            --
            key : text
            description : text
            default_state : boolean
            allowed_audiences : text[]
            tenant_overrides : jsonb
            owner : text
            review_cadence_days : integer
            expires_at : timestamptz
            created_at : timestamptz
            updated_at : timestamptz
        }
        entity "AuditEvent" as audit_event {
            * id : uuid
            --
            tenant_id : uuid
            actor_type : text
            actor_id : uuid
            action : text
            target_type : text
            target_id : uuid
            metadata : jsonb
            impersonation_context : jsonb
            occurred_at : timestamptz
            correlation_id : uuid
        }
        entity "BackgroundJob" as background_job {
            * id : uuid
            --
            tenant_id : uuid
            queue : text
            priority : integer
            payload : jsonb
            attempts : integer
            last_error : text
            run_at : timestamptz
            locked_by : text
            locked_at : timestamptz
            finished_at : timestamptz
            created_at : timestamptz
        }
        entity "WebhookEvent" as webhook_event {
            * id : uuid
            --
            tenant_id : uuid
            provider : text
            event_type : text
            payload : jsonb
            signature : text
            received_at : timestamptz
            processed_at : timestamptz
            status : text
            retries : integer
        }
        entity "PlatformCommand" as platform_command {
            * id : uuid
            --
            tenant_id : uuid
            actor_id : uuid
            command : text
            payload : jsonb
            rationale : text
            executed_at : timestamptz
            status : text
        }
        tenant ||--o{ store_user : tenants own many store users
        tenant ||--o{ customer : tenants own many customers
        tenant ||--o{ product : tenants publish many products
        product ||--o{ variant : products include many variants
        tenant ||--o{ category : tenants define categories
        tenant ||--o{ collection : tenants configure collections
        variant |o--o{ inventory_level : variants tracked per location
        inventory_location ||--o{ inventory_level : locations host inventory levels
        tenant ||--o{ consignor : tenants onboard consignors
        consignor ||--o{ consignment_item : consignors supply many items
        variant |o--o{ consignment_item : variants link to consignment records
        tenant ||--o{ cart : tenants maintain many carts
        cart |o--|| orders : orders originate from carts
        orders ||--o{ order_item : orders contain many items
        orders ||--|| payment_intent : orders map to payment intents
        payment_intent ||--o{ refund : payment intents yield refunds
        orders ||--o{ shipment : orders ship via many shipments
        orders ||--o{ return_auth : orders may have return authorizations
        customer ||--o{ cart : customers maintain carts
        customer ||--o{ orders : customers place orders
        customer ||--o{ loyalty_ledger : customers accrue loyalty entries
        tenant ||--o{ feature_flag : tenants reference feature flag overrides
        tenant ||--o{ audit_event : tenants emit audit events
        tenant ||--o{ background_job : tenants queue background jobs
        tenant ||--o{ webhook_event : tenants log webhook events
        tenant ||--o{ platform_command : tenants receive platform commands
        orders ||--o{ shipment : orders produce shipments
        orders |o--o{ loyalty_ledger : orders adjust loyalty ledger
        orders ||--o{ audit_event : orders create audit events
        store_user ||--o{ audit_event : staff actions recorded
        feature_flag ||--o{ platform_command : platform commands adjust flags
        background_job |o--o{ webhook_event : jobs process webhooks
        tenant ||--o{ session_log : tenants capture session logs
        @enduml
        ~~~

---

<!-- anchor: line-count-guidelines -->
## Structural & Data Architect Output - `02_System_Structure_and_Data.md`

| Project Scale | Line Count | Diagram Complexity |
|---------------|------------|-------------------|
| **Small** | 200-350 lines | - 1 Context diagram (30-40 lines)<br>- 1 Container diagram (40-60 lines)<br>- Simple ERD (20-30 lines)<br>- Minimal component detail |
| **Medium** | 500-800 lines | - Context diagram (50-70 lines)<br>- Container diagram (80-120 lines)<br>- Component diagram (60-100 lines)<br>- Detailed ERD (40-80 lines) |
| **Large** | 1000-1500 lines | - Complex Context (80-120 lines)<br>- Multiple Container views (150-250 lines)<br>- 2-3 Component diagrams (200-300 lines)<br>- Comprehensive ERD (100-150 lines) |
| **Enterprise** | 1800-2500 lines | - Enterprise Context (150-200 lines)<br>- Multiple system boundaries (300-400 lines)<br>- 4-6 Component diagrams (400-600 lines)<br>- Multi-schema ERD (200-300 lines) |

**Content Distribution:**
- Introduction & Goals: 10-15%
- Architectural Drivers: 10-15%
- Diagrams (PlantUML): 50-60%
- Descriptions & Explanations: 20-25%

**Quality Guidelines:**

MUST adhere to the specified line count range. Diagram content MUST be 50-60% of total lines. All required diagrams (Context, Container, Component, ERD) are MANDATORY. Outputs below minimum are INCOMPLETE. Outputs above maximum are OVER-DETAILED.
<!-- anchor: appendix-structural-notes -->
## Appendix: Extended Structural Notes

The appendix enumerates additional structural commitments derived from Foundation Sections 3–6 so downstream architects inherit precise stewardship, retention, and support-entity coverage without re-opening baseline diagrams.

<!-- anchor: appendix-module-data-matrix -->
### Module-to-Data Stewardship Matrix

| Module | Primary Entities | Stewardship Notes |
| --- | --- | --- |
| Tenant Access Gateway | Tenant, FeatureFlag, TenantFlagHistory | Maintains canonical tenant resolution data, records host/custom-domain provenance, and logs feature switch lineage. |
| Identity & Session Service | StoreUser, Customer, SessionLog, AuditEvent | Guards authentication, MFA secrets, impersonation metadata, and immutable audit append-only writes. |
| Catalog & Inventory Module | Product, Variant, Category, Collection, InventoryLocation, InventoryLevel | Owns schema evolution, versioning, and indexing for product discovery, variant explosion, and multi-location stock states. |
| Consignment Module | Consignor, ConsignmentItem, PayoutBatch | Maintains encrypted tax info, commission policy snapshots, payout ledger traces, and vendor communications. |
| Checkout & Order Orchestrator | Cart, CartItem, Order, OrderItem, Shipment, ReturnAuthorization | Enforces saga sequencing, concurrency control (version columns), and rollback-safe snapshots for payment and fulfillment. |
| Payment Integration Layer | PaymentIntent, Refund, GiftCard, StoreCreditLedger | Abstracts providers, stores provider references, and ensures PCI scope stays delegated to Stripe Connect. |
| Loyalty & Rewards Module | LoyaltyLedgerEntry, TierDefinition | Tracks point accrual/expiration, tier transitions, and audit hooks for fraud reviews. |
| POS & Offline Processor | PosDevice, OfflineTransaction | Manages device enrollment, offline blob encryption, replay ordering, and reconciliation telemetry. |
| Media Pipeline Controller | MediaAsset, MediaDerivative, MediaJob | Validates uploads, enforces tenant path prefixes, tracks job progress, and cleans orphaned derivatives. |
| Reporting Projection Service | ReportingAggregate, ReportJob | Builds read-optimized tables, monitors freshness, and exposes metadata for dashboards and exports. |
| Platform Admin Backend | PlatformCommand, DomainEvent | Orchestrates SaaS governance, impersonation approvals, and platform-facing analytics queries. |
| Integration Adapter Layer | WebhookEvent, RateLimitBucket | Handles inbound/outbound webhook persistence, idempotency keys, and hybrid PostgreSQL/Caffeine rate limiting. |

<!-- anchor: appendix-retention-responsibilities -->
### Data Retention Responsibilities

*   Background jobs rotate partitions monthly, ensuring session, audit, webhook, and job tables purge hot data at 90-day marks before archiving to Cloudflare R2.
*   Consignor tax information uses pgcrypto and rotates keys quarterly; Stewardship includes manifest metadata for each archive to satisfy audits.
*   Loyalty ledger data keeps five years of history in hot storage to support lifetime value analytics; archives beyond this period compress to tenant-specific JSONL objects.
*   POS offline blobs delete automatically once reconciliation completes and receipts post, but metadata (device, checksum, replay time) persists for 24 months.
*   MediaAsset records maintain both original and derivative hashes; stale derivatives are tombstoned after replacement versions propagate through CDN caches.
*   FeatureFlag overrides expire automatically when review_cadence_days elapses; PlatformCommand records capture revert operations for compliance.
*   Webhook events retain payloads until downstream acknowledgement; failure payloads stay until manual dismissal with reason codes stored in AuditEvent.
*   Reporting aggregates annotate `data_freshness_timestamp` and the name of the scheduled job that produced them, enabling SLA dashboards to surface lagging projections.
*   Subscription contracts (future phase) will inherit retention windows aligned with payment processor requirements while storing cancel-at-period-end metadata.
*   Gift card and store credit ledgers never purge entries; instead they soft-close records when balances hit zero to preserve auditability for chargeback disputes.

<!-- anchor: appendix-support-entities-erd -->
### Supplemental ERD - Support Entities

*   **Description:** Supplements Section 3.6 by illustrating ancillary entities (gift cards, store credit, subscriptions, POS devices, domain events, media assets, rate limiters) that extend core domains without bloating the primary ERD. These structures inherit tenant_id columns, RLS, and archival policies identical to their parent modules.
*   **Diagram (PlantUML):**
        ~~~plantuml
        @startuml
        entity "Tenant (ref)" as tenant_ref {
            * id : uuid
            --
            tenant_key : citext
        }
        entity "Cart (ref)" as cart_ref {
            * id : uuid
            --
            tenant_id : uuid
        }
        entity "Order (ref)" as order_ref {
            * id : uuid
            --
            tenant_id : uuid
        }
        entity "Customer (ref)" as customer_ref {
            * id : uuid
            --
            tenant_id : uuid
        }
        entity "CartItem" as cart_item {
            * id : uuid
            --
            tenant_id : uuid
            cart_id : uuid
            variant_snapshot : jsonb
            quantity : integer
            price_minor : bigint
            discounts : jsonb
            loyalty_applied_minor : bigint
            created_at : timestamptz
        }
        entity "GiftCard" as gift_card {
            * id : uuid
            --
            tenant_id : uuid
            code : text
            initial_balance_minor : bigint
            remaining_balance_minor : bigint
            status : text
            expires_at : timestamptz
            issued_order_id : uuid
            redeemed_order_ids : uuid[]
            created_at : timestamptz
        }
        entity "StoreCreditLedger" as store_credit {
            * id : uuid
            --
            tenant_id : uuid
            customer_id : uuid
            credit_delta_minor : bigint
            balance_after_minor : bigint
            reason : text
            origin_order_id : uuid
            expires_at : timestamptz
            created_at : timestamptz
        }
        entity "SubscriptionPlan" as subscription_plan {
            * id : uuid
            --
            tenant_id : uuid
            name : text
            interval : text
            interval_count : integer
            trial_period_days : integer
            metadata : jsonb
            status : text
            created_at : timestamptz
        }
        entity "SubscriptionContract" as subscription_contract {
            * id : uuid
            --
            tenant_id : uuid
            customer_id : uuid
            plan_id : uuid
            status : text
            next_billing_at : timestamptz
            cancel_at_period_end : boolean
            proration_behavior : text
            provider_reference : text
            created_at : timestamptz
            updated_at : timestamptz
        }
        entity "PosDevice" as pos_device {
            * id : uuid
            --
            tenant_id : uuid
            location_id : uuid
            device_identifier : text
            status : text
            last_seen_at : timestamptz
            firmware_version : text
            offline_queue_depth : integer
            created_at : timestamptz
        }
        entity "DomainEvent" as domain_event {
            * id : uuid
            --
            tenant_id : uuid
            aggregate_type : text
            aggregate_id : uuid
            event_type : text
            payload : jsonb
            occurred_at : timestamptz
            processed_by_projection : jsonb
        }
        entity "MediaAsset" as media_asset {
            * id : uuid
            --
            tenant_id : uuid
            scope : text
            storage_key : text
            mime_type : text
            checksum : text
            original_dimensions : jsonb
            status : text
            created_at : timestamptz
            updated_at : timestamptz
        }
        entity "MediaDerivative" as media_derivative {
            * id : uuid
            --
            tenant_id : uuid
            media_asset_id : uuid
            variant_type : text
            storage_key : text
            mime_type : text
            checksum : text
            width : integer
            height : integer
            created_at : timestamptz
        }
        entity "RateLimitBucket" as rate_limit {
            * id : uuid
            --
            tenant_id : uuid
            subject_key : text
            window_start : timestamptz
            window_end : timestamptz
            allowance : integer
            consumed : integer
            last_request_at : timestamptz
        }
        entity "TenantFlagHistory" as tenant_flag_history {
            * id : uuid
            --
            tenant_id : uuid
            feature_key : text
            previous_state : boolean
            new_state : boolean
            changed_by : uuid
            changed_at : timestamptz
            rationale : text
        }
        entity "OfflineTransaction" as offline_txn {
            * id : uuid
            --
            tenant_id : uuid
            pos_device_id : uuid
            payload_ciphertext : bytea
            queued_at : timestamptz
            replayed_at : timestamptz
            replay_status : text
            checksum : text
        }
        tenant_ref ||--o{ cart_item : "tenants own cart line items"
        cart_ref ||--o{ cart_item : "carts include items"
        tenant_ref ||--o{ gift_card : "tenants issue gift cards"
        tenant_ref ||--o{ store_credit : "tenants manage store credit" 
        customer_ref ||--o{ store_credit : "customers accrue credits"
        tenant_ref ||--o{ subscription_plan : "tenants configure plans"
        subscription_plan ||--o{ subscription_contract : "plans spawn contracts"
        customer_ref ||--o{ subscription_contract : "customers enroll in subscriptions"
        order_ref ||--o{ subscription_contract : "orders seed subscriptions"
        tenant_ref ||--o{ pos_device : "tenants enroll POS devices"
        pos_device ||--o{ offline_txn : "devices produce offline txns"
        tenant_ref ||--o{ domain_event : "tenants emit domain events"
        tenant_ref ||--o{ media_asset : "tenants upload media"
        media_asset ||--o{ media_derivative : "assets yield derivatives"
        tenant_ref ||--o{ rate_limit : "tenants maintain rate buckets"
        tenant_ref ||--o{ tenant_flag_history : "tenants capture feature history"
        gift_card ||--o{ store_credit : "gift card redemption can credit accounts"
        domain_event ||..|| reportingProjection : "events consumed by projections"
        @enduml
        ~~~
