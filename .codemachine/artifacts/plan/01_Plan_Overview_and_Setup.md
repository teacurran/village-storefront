<!-- anchor: project-plan-village-storefront -->
# Project Plan: Village Storefront

**Version:** 1.0
**Date:** 2026-01-02
**Generated By:** Codex (GPT-5)

<!-- anchor: project-overview -->
## 1. Project Overview

* **Goal:** Deliver a configurable multi-tenant ecommerce + consignment SaaS that pairs Quarkus-native backend services, Qute storefront, Vue admin SPA, and robust operational tooling so small/medium merchants can launch branded stores quickly while scaling to advanced workflows.
* **High-Level Requirements Summary:**
  - Tenant isolation via TenantContext filter, PostgreSQL RLS, Panache filters, multi-domain routing, and suspension flows.
  - Role-based identity (merchant, staff, customers, platform admins), JWT/refresh tokens, impersonation logs, and audit-ready reporting.
  - Comprehensive catalog, variants, consignment parity, multi-location inventory, POS, loyalty, background media processing, and headless APIs.
  - Checkouts with Stripe Connect, shipping carrier integrations, returns/refunds, gift cards/store credit, and reporting dashboards.
  - Non-functional mandates: Java 21 + Quarkus, GraalVM native builds, MyBatis migrations, Caffeine caches, Kubernetes/K3s deployment, structured logging, OpenTelemetry, and multi-currency display.
* **Key Assumptions:**
  - Feature delivery is staged by Phase 1→3 priorities, but initial architecture seeds extensibility for upcoming modules (consignment automation, POS, loyalty).
  - GitHub Actions + SonarCloud enforce coverage/formatting; local developers follow `docs/java-project-standards.adoc` without deviation.
  - PostgreSQL 17 remains the only persistent store; background queues rely on database tables per the DelayedJob standard.
  - Cloudflare R2 acts as default object storage/CDN and FFmpeg is bundled within worker images to satisfy video requirements.
  - Internationalization (English/Spanish) relies on MessageBundle + vue-i18n with translation assets stored in repo.

<!-- anchor: project-scale-classification -->
### 1.1 Project Scale Classification

| Category | Typical Team Size | Duration | Complexity | Codebase Size | Scope/Goal |
| :--- | :--- | :--- | :--- | :--- | :--- |
| Small | 1–3 | Days to Weeks | Low | KLOC | Prototype/Utility |
| Medium | 3–10 | Weeks to Months | Moderate | Tens of KLOC | Departmental MVP |
| **Large (Selected)** | 10–50+ | 6 Months to 2 Years | High | Hundreds of KLOC | Complex platform spanning multi-tenant commerce, consignment, POS, loyalty, and platform ops |
| Enterprise-Grade | 50+ | Years | Extremely High | Millions of KLOC | Mission-critical suites |

*Rationale:* Requirement breadth (multi-tenant commerce, consignment parity, payments, POS, reporting, Kubernetes-native ops) exceeds startup MVP, so this plan targets the **Large** row with 5 iterations and rich artifacts.

<!-- anchor: core-architecture -->
## 2. Core Architecture

* **Architectural Style:** Layered modular monolith with bounded contexts (tenant access, identity, catalog, consignment, checkout, payments, loyalty, media, POS, reporting) communicating via CDI contracts and persisted domain events; horizontal slices align with Quarkus modules and Maven subprojects.
* **Technology Stack:**
    * Frontend: Qute templates + Tailwind + PrimeUI for storefront; Vue 3 + Vite + TypeScript + PrimeVue via Quinoa for `/admin/*`.
    * Backend: Java 21, Quarkus (RESTEasy Reactive, Qute, Panache, Scheduler, Kubernetes, Mailer, AWS S3, OpenTelemetry), MapStruct DTO mappers, Caffeine caching.
    * Database: PostgreSQL 17 with Row-Level Security, partitioned audit/session tables, JSONB payloads for jobs/events; MyBatis migrations manage schema/policies.
    * Messaging/Queues: Database-backed DelayedJob with CRITICAL/HIGH/DEFAULT/LOW/BULK priorities and worker pods.
    * Deployment: GraalVM native builds packaged in distroless containers, Quarkus Kubernetes extension manifests consumed by GitHub Actions → k3s.
    * Other tools: Stripe Connect SDK, Quarkus Mailer, Thumbnailator + ImageIO, FFmpeg process runner, OpenTelemetry + Jaeger, Prometheus, Spotless, JaCoCo, SonarCloud, Tailwind token generator, vue-i18n, Feature flag service.
* **Key Components/Services:** Tenant Access Gateway, Identity & Session, Storefront Rendering Engine, Admin SPA Delivery, Catalog & Inventory, Consignment, Checkout & Order Orchestrator, Payment Integration Layer, Loyalty & Rewards, POS & Offline Processor, Media Pipeline, Background Job Scheduler, Reporting & Analytics, Platform Admin Console, Integration Adapter layer; Component Diagram (PlantUML) elaborated in `I1.T2`.
* **Data Model Overview:** Core entities include Tenant, StoreUser, Customer, SessionLog, Product/Variant, Category/Collection, InventoryLocation/InventoryLevel, Consignor/ConsignmentItem, Cart, Order, PaymentIntent, Refund, Shipment, ReturnAuthorization, LoyaltyLedgerEntry, FeatureFlag, AuditEvent, BackgroundJob, WebhookEvent; initial ERD authored in Mermaid under `I1.T3` and refined through later iterations for loyalty/POS additions.
* **API Contract Style:** RESTful spec-first OpenAPI 3.0 (YAML) with multi-tenant path semantics `/api/v1/tenants/{tenantId}/...` plus platform scopes; initial spec seeded in `I1.T4`, expanded in iterations focusing on catalog, checkout, consignment, loyalty, POS, and headless APIs; RFC7807 error shape mandated; SSE/Webhook contracts documented with schema components.
* **Communication Patterns:** Request filters resolve tenants + feature flags; controllers call domain services via CDI; background jobs persist events for asynchronous handling; payment + carrier integrations encapsulated via adapter interfaces; SSE for admin notifications; diagrams: Sequence Diagram 1 (Storefront checkout) `I2.T3`, Sequence Diagram 2 (Consignment payout) `I3.T2`, Sequence Diagram 3 (Media processing) `I3.T5`, Sequence Diagram 4 (Platform impersonation) `I4.T3`.

<!-- anchor: key-artifacts -->
## 2.1. Key Architectural Artifacts Planned

* Component Diagram (PlantUML, `docs/diagrams/component-overview.puml`) – visualizes core bounded contexts, data stores, and integrations; created in `I1.T2`.
* Multi-Tenant ERD (Mermaid, `docs/diagrams/tenant-erd.mmd`) – outlines shared tables, tenant_id keys, and RLS policies; created in `I1.T3`, refined `I3.T1`.
* Initial OpenAPI Spec (YAML, `api/openapi-base.yaml`) – seeds auth/tenant/cms endpoints; produced in `I1.T4`, extended each iteration with additional tags.
* Checkout Sequence Diagram (PlantUML, `docs/diagrams/seq-checkout.puml`) – details checkout orchestration; produced `I2.T3`.
* Consignment Payout Sequence Diagram (PlantUML, `docs/diagrams/seq-consignment-payout.puml`) – clarifies payout automation; produced `I3.T2`.
* Media Pipeline Sequence Diagram (PlantUML, `docs/diagrams/seq-media-processing.puml`) – depicts upload→FFmpeg flow; produced `I3.T5`.
* Platform Impersonation Sequence Diagram (PlantUML, `docs/diagrams/seq-impersonation.puml`) – secures audit flow; produced `I4.T3`.
* Loyalty Domain Model Addendum (Markdown + Mermaid, `docs/diagrams/loyalty-model.mmd`) – adds ledger/tier relationships; produced `I4.T1`.
* POS Offline Flow Diagram (Mermaid flowchart, `docs/diagrams/pos-offline-flow.mmd`) – ensures offline safety; produced `I5.T2`.
* Job Governance ADR (Markdown, `docs/adr/0001-delayed-job-governance.md`) – documents queue policies referenced by workers; produced `I2.T1`.
* Feature Flag Strategy ADR (Markdown, `docs/adr/0002-feature-flag-governance.md`) – codifies toggle lifecycle; produced `I2.T2`.
* Deployment Pipeline Map (Mermaid, `docs/diagrams/ci-cd-pipeline.mmd`) – clarifies GitHub Actions + Kubernetes flow; produced `I2.T5`.

<!-- anchor: directory-structure -->
## 3. Directory Structure

* **Root Directory:** `village-storefront/`
* **Structure Definition:**
```
village-storefront/
├── README.md
├── pom.xml
├── mvnw / mvnw.cmd
├── src/
│   ├── main/java/com/village/storefront/
│   │   ├── tenant/
│   │   ├── identity/
│   │   ├── catalog/
│   │   ├── inventory/
│   │   ├── consignment/
│   │   ├── checkout/
│   │   ├── payments/
│   │   ├── loyalty/
│   │   ├── pos/
│   │   ├── media/
│   │   ├── reporting/
│   │   └── platformops/
│   ├── main/resources/
│   │   ├── application.properties
│   │   ├── db/migrations/ (MyBatis)
│   │   ├── messages/ (Qute MessageBundle)
│   │   └── templates/ (Qute)
│   ├── main/webui/ (Vue admin via Quinoa)
│   └── test/java/... (unit + integration suites)
├── ui-storefront/ (Tailwind/PrimeUI assets + Qute fragments)
├── docs/
│   ├── diagrams/
│   │   ├── component-overview.puml
│   │   ├── tenant-erd.mmd
│   │   ├── seq-checkout.puml
│   │   ├── seq-consignment-payout.puml
│   │   ├── seq-media-processing.puml
│   │   ├── seq-impersonation.puml
│   │   ├── loyalty-model.mmd
│   │   └── pos-offline-flow.mmd
│   ├── adr/
│   │   ├── 0001-delayed-job-governance.md
│   │   └── 0002-feature-flag-governance.md
│   └── standards/
│       └── java-project-standards.adoc (reference copy or symlink)
├── api/
│   ├── openapi-base.yaml
│   ├── openapi-catalog.yaml
│   ├── openapi-checkout.yaml
│   └── openapi-headless.yaml
├── ops/
│   ├── k8s/
│   │   ├── base/ (Quarkus-generated manifests)
│   │   └── overlays/{dev,staging,prod}/
│   ├── github-actions/
│   └── scripts/ (migration runners, smoke tests)
├── jobs/
│   ├── workers/ (job definitions, payload schemas)
│   └── manifests/
├── tools/
│   ├── ffmpeg/ (version pin metadata)
│   └── tailwind/ (design token export scripts)
├── tests/
│   ├── integration/
│   ├── acceptance/
│   └── perf/
└── .codemachine/
    ├── artifacts/
    │   └── plan/ (this planning package)
    └── inputs/
        └── competitor-research.md
```

*Justification:* Structure separates bounded contexts for clarity, ensures documentation + diagrams are versioned under `docs/`, isolates API specs for spec-first workflow, houses ops artifacts for Kubernetes + CI/CD, and reserves `.codemachine/artifacts/plan` for this generated planning bundle.
