---
# Production-specific patches for standard worker deployment
# Optimized for reliability, performance, and observability
apiVersion: apps/v1
kind: Deployment
metadata:
  name: village-storefront-workers
  annotations:
    deployment.kubernetes.io/revision-history-limit: "10"
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 2
      maxUnavailable: 0  # Zero-downtime updates

  template:
    metadata:
      annotations:
        # Force pod restart on config/secret changes
        checksum/config: "will-be-replaced-by-kustomize"
        # Production pod security annotations
        seccomp.security.alpha.kubernetes.io/pod: runtime/default
    spec:
      # Production affinity rules
      affinity:
        podAntiAffinity:
          # Hard requirement: spread across nodes
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: component
                operator: In
                values:
                - workers
            topologyKey: kubernetes.io/hostname
          # Soft preference: spread across zones
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: component
                  operator: In
                  values:
                  - workers
              topologyKey: topology.kubernetes.io/zone

      containers:
      - name: worker
        # Production resource allocation
        resources:
          requests:
            cpu: "500m"
            memory: "1Gi"
          limits:
            cpu: "2000m"
            memory: "4Gi"

        # Production-tuned health probes
        livenessProbe:
          httpGet:
            path: /q/health/live
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1

        readinessProbe:
          httpGet:
            path: /q/health/ready
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1

        # Startup probe for native image boot
        startupProbe:
          httpGet:
            path: /q/health/started
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 30

        # Production environment configuration
        env:
        - name: QUARKUS_PROFILE
          value: "production"

        - name: QUARKUS_LOG_LEVEL
          value: "INFO"

        - name: QUARKUS_LOG_CONSOLE_JSON
          value: "true"

        # Structured logging with correlation
        - name: QUARKUS_LOG_CONSOLE_FORMAT
          value: "%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{3.}] (%t) %X{correlation-id} %X{tenant-id} %s%e%n"

        # Production queue capacities
        - name: JOBS_QUEUE_CAPACITY_CRITICAL
          value: "1000"

        - name: JOBS_QUEUE_CAPACITY_HIGH
          value: "5000"

        - name: JOBS_QUEUE_CAPACITY_DEFAULT
          value: "10000"

        - name: JOBS_QUEUE_CAPACITY_BULK
          value: "50000"

        # Production retry settings
        - name: JOBS_RETRY_MAX_ATTEMPTS_CRITICAL
          value: "5"

        - name: JOBS_RETRY_MAX_ATTEMPTS_DEFAULT
          value: "3"

        # Connection pool tuning
        - name: QUARKUS_DATASOURCE_JDBC_MAX_SIZE
          value: "20"

        - name: QUARKUS_DATASOURCE_JDBC_MIN_SIZE
          value: "5"

        # Optimized JVM settings for production
        - name: JAVA_OPTS
          value: >-
            -XX:MaxRAMPercentage=75.0
            -XX:+UseG1GC
            -XX:MaxGCPauseMillis=200
            -XX:+ExitOnOutOfMemoryError
            -XX:+HeapDumpOnOutOfMemoryError
            -XX:HeapDumpPath=/tmp/heapdump.hprof
            -XX:+UnlockDiagnosticVMOptions
            -XX:+DebugNonSafepoints

        # OpenTelemetry tracing (sampled)
        - name: QUARKUS_OTEL_TRACES_SAMPLER
          value: "traceidratio"

        - name: QUARKUS_OTEL_TRACES_SAMPLER_ARG
          value: "0.1"  # 10% sampling in production

        # Metrics export
        - name: QUARKUS_MICROMETER_EXPORT_PROMETHEUS_ENABLED
          value: "true"

        - name: QUARKUS_MICROMETER_BINDER_JVM_ENABLED
          value: "true"

        # Graceful shutdown timeout
        - name: QUARKUS_SHUTDOWN_TIMEOUT
          value: "30s"

        # Security: disable dev endpoints
        - name: QUARKUS_DEV_SERVICES_ENABLED
          value: "false"

        - name: QUARKUS_SWAGGER_UI_ALWAYS_INCLUDE
          value: "false"
