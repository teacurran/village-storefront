---
# Staging-specific patches for worker deployment
# Production-equivalent resources with staging-specific tuning
apiVersion: apps/v1
kind: Deployment
metadata:
  name: village-storefront-workers
spec:
  template:
    metadata:
      annotations:
        # Force pod restart on config changes in staging
        configmap-hash: "will-be-replaced-by-kustomize"
    spec:
      containers:
      - name: worker
        # Production-equivalent resource allocation
        resources:
          requests:
            cpu: "250m"
            memory: "512Mi"
          limits:
            cpu: "1000m"
            memory: "2Gi"

        # Production-like probes with slightly relaxed timing
        livenessProbe:
          httpGet:
            path: /q/health/live
            port: 8080
          initialDelaySeconds: 45
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /q/health/ready
            port: 8080
          initialDelaySeconds: 25
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        # Staging-specific environment configuration
        env:
        - name: QUARKUS_PROFILE
          value: "staging"

        - name: QUARKUS_LOG_LEVEL
          value: "INFO"

        - name: QUARKUS_LOG_CONSOLE_JSON
          value: "true"

        # Enable additional debug logging for staging validation
        - name: QUARKUS_LOG_CATEGORY_VILLAGECOMPUTE_STOREFRONT_LEVEL
          value: "DEBUG"

        # Staging queue capacities (production-like)
        - name: JOBS_QUEUE_CAPACITY_CRITICAL
          value: "1000"

        - name: JOBS_QUEUE_CAPACITY_HIGH
          value: "5000"

        - name: JOBS_QUEUE_CAPACITY_DEFAULT
          value: "10000"

        # Production retry settings
        - name: JOBS_RETRY_MAX_ATTEMPTS_CRITICAL
          value: "5"

        - name: JOBS_RETRY_MAX_ATTEMPTS_DEFAULT
          value: "3"

        # Staging-specific feature flags (enable canary features)
        - name: FEATURE_TOGGLE_ALLOW_CANARY
          value: "true"

        # JVM options matching production
        - name: JAVA_OPTS
          value: "-XX:MaxRAMPercentage=75.0 -XX:+UseG1GC -XX:+ExitOnOutOfMemoryError"

        # Tracing sample rate (100% in staging for debugging)
        - name: QUARKUS_OTEL_TRACES_SAMPLER
          value: "always_on"
